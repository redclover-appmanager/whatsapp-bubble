!function(){"use strict";function t(t,e,i,s){return new(i||(i=Promise))(function(e,o){function n(t){try{a(s.next(t))}catch(e){o(e)}}function r(t){try{a(s.throw(t))}catch(e){o(e)}}function a(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(function(t){t(s)})).then(n,r)}a((s=s.apply(t,[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class e{constructor(t){this.config={},this.authData=null,this.container=null,this.isInitialized=!1,this.widgetName=t.name,this.widgetVersion=t.version,this.options=Object.assign({cache:!0,cacheDuration:3600,retryAttempts:3,retryDelay:1e3,analytics:!1,debug:!1},t.options);const e=this.getCurrentScript();if(!e)throw new Error("[Widget SDK] Could not find script tag");if(this.websiteId=e.getAttribute("data-website-id")||"",this.appId=e.getAttribute("data-app-id")||"",this.koruUrl=e.getAttribute("data-app-manager-url")||"",!this.websiteId||!this.appId||!this.koruUrl)throw new Error("[Widget SDK] Missing required data attributes");this.log("SDK initialized",{websiteId:this.websiteId,appId:this.appId})}start(){return t(this,0,void 0,function*(){try{if(yield this.waitForDOM(),this.authData=yield this.authorize(),!this.authData.authorized)return void this.log("Widget not authorized");this.config=this.authData.config,yield this.onInit(this.config),yield this.onRender(this.config),this.isInitialized=!0,this.log("Widget started successfully"),this.options.analytics&&this.track("widget_loaded",{widget:this.widgetName,version:this.widgetVersion})}catch(t){this.handleError("Failed to start widget",t)}})}stop(){return t(this,0,void 0,function*(){try{yield this.onDestroy(),this.isInitialized=!1,this.log("Widget stopped")}catch(t){this.handleError("Failed to stop widget",t)}})}reload(){return t(this,0,void 0,function*(){try{if(this.clearCache(),this.authData=yield this.authorize(),!this.authData.authorized)return;const t=this.authData.config;this.onConfigUpdate?yield this.onConfigUpdate(t):(yield this.onDestroy(),yield this.onRender(t)),this.config=t,this.log("Widget reloaded")}catch(t){this.handleError("Failed to reload widget",t)}})}authorize(){return t(this,0,void 0,function*(){if(this.options.cache){const t=this.getFromCache();if(t)return this.log("Using cached authorization"),t}let t=null;for(let i=1;i<=this.options.retryAttempts;i++)try{this.log(`Authorization attempt ${i}/${this.options.retryAttempts}`);const t=`${this.koruUrl}/api/widget/authorize?website_id=${this.websiteId}&app_id=${this.appId}`,e=yield fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`Authorization failed: ${e.status}`);const s=yield e.json();return this.options.cache&&this.saveToCache(s),s}catch(e){t=e,this.log(`Authorization attempt ${i} failed:`,e),i<this.options.retryAttempts&&(yield this.sleep(this.options.retryDelay))}throw t||new Error("Authorization failed")})}createElement(t,e){const i=document.createElement(t);if(e){const{className:t,style:s,onClick:o,children:n}=e,r=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(t);o<s.length;o++)e.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(t,s[o])&&(i[s[o]]=t[s[o]])}return i}(e,["className","style","onClick","children"]);t&&(i.className=t),s&&Object.assign(i.style,s),o&&i.addEventListener("click",o),n&&n.forEach(t=>{"string"==typeof t?i.appendChild(document.createTextNode(t)):i.appendChild(t)}),Object.assign(i,r)}return i}isMobile(){return/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}track(t,e){if(this.options.analytics)try{const i=`${this.koruUrl}/api/widget/analytics`;fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({website_id:this.websiteId,app_id:this.appId,event_type:t,event_data:Object.assign({widget:this.widgetName,version:this.widgetVersion},e)})}).catch(t=>this.log("Analytics error:",t))}catch(i){this.log("Failed to track event:",i)}}log(t,...e){this.options.debug}handleError(t,e){this.options.analytics&&this.track("widget_error",{error:e instanceof Error?e.message:String(e),message:t})}getCurrentScript(){return document.currentScript}waitForDOM(){return t(this,0,void 0,function*(){if("loading"===document.readyState)return new Promise(t=>{document.addEventListener("DOMContentLoaded",()=>t())})})}sleep(t){return new Promise(e=>setTimeout(e,t))}getCacheKey(){return`koru_widget_${this.websiteId}_${this.appId}`}getFromCache(){try{const t=this.getCacheKey(),e=localStorage.getItem(t);if(!e)return null;const{data:i,timestamp:s}=JSON.parse(e);return(Date.now()-s)/1e3>this.options.cacheDuration?(this.clearCache(),null):i}catch(t){return null}}saveToCache(t){try{const e=this.getCacheKey();localStorage.setItem(e,JSON.stringify({data:t,timestamp:Date.now()}))}catch(e){this.log("Failed to cache auth data:",e)}}clearCache(){try{const t=this.getCacheKey();localStorage.removeItem(t)}catch(t){}}}(new class extends e{constructor(){super({name:"whatsapp-bubble",version:"1.0.0",options:{cache:!0,analytics:!0,debug:!1}}),this.bubble=null}async onInit(t){if(!t.phone_number)throw new Error("phone_number is required");if(!/^[0-9]{10,15}$/.test(t.phone_number))throw new Error("Invalid phone_number format");!1!==t.enabled?this.log("Widget initialized",t):this.log("Widget is disabled in configuration")}async onRender(t){this.bubble=document.createElement("div"),this.bubble.className="whatsapp-bubble";const e=this.getBubbleStyles(t);Object.keys(e).forEach(t=>{this.bubble.style[t]=e[t]});const i=this.getIconElement();this.bubble.appendChild(i),this.bubble.addEventListener("click",()=>this.handleClick(t)),!1!==t.show_tooltip&&(this.bubble.setAttribute("title",t.tooltip_text||"Chat with us on WhatsApp"),this.bubble.setAttribute("aria-label",t.tooltip_text||"Chat with us on WhatsApp")),this.bubble.setAttribute("role","button"),this.bubble.setAttribute("tabindex","0"),this.bubble.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this.handleClick(t))}),document.body.appendChild(this.bubble),this.log("Widget rendered")}async onDestroy(){this.bubble&&(this.bubble.remove(),this.bubble=null),this.log("Widget destroyed")}async onConfigUpdate(t){await this.onDestroy(),await this.onRender(t),this.log("Widget updated with new config")}handleClick(t){const e=t.phone_number,i=encodeURIComponent(t.default_message||""),s=this.isMobile()?`whatsapp://send?phone=${e}&text=${i}`:`https://web.whatsapp.com/send?phone=${e}&text=${i}`;this.track("whatsapp_clicked",{phone:e,has_message:!!t.default_message,position:t.position}),window.open(s,"_blank")}getBubbleStyles(t){const e=t.bubble_size||60,i=t.offset_x||20,s=t.offset_y||20;return{position:"fixed",width:`${e}px`,height:`${e}px`,backgroundColor:t.bubble_color||"#25D366",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:"999999",transition:"transform 0.3s ease, box-shadow 0.3s ease",...{"bottom-right":{bottom:`${s}px`,right:`${i}px`},"bottom-left":{bottom:`${s}px`,left:`${i}px`},"top-right":{top:`${s}px`,right:`${i}px`},"top-left":{top:`${s}px`,left:`${i}px`}}[t.position||"bottom-right"]}}getIconElement(){const t=document.createElement("div");return t.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      width: 100%;\n      height: 100%;\n    ",t.innerHTML='\n      <svg width="60%" height="60%" viewBox="0 0 24 24" fill="white">\n        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>\n      </svg>\n    ',t.addEventListener("mouseenter",()=>{this.bubble&&(this.bubble.style.transform="scale(1.1)",this.bubble.style.boxShadow="0 6px 20px rgba(0,0,0,0.25)")}),t.addEventListener("mouseleave",()=>{this.bubble&&(this.bubble.style.transform="scale(1)",this.bubble.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)")}),t}}).start()}();
